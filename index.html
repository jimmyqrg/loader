<!doctype html>
<html lang="en">
<head>
  <script src="/js/panicKey.js"></script>
  <script src="/js/openGame.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title></title>

  <!-- Favicon element that weâ€™ll replace dynamically -->
  <link id="cloakFavicon" rel="icon" href="">
  <style>
    html,body { height:100%; margin:0; }
    .center { display:flex; align-items:center; justify-content:center; height:100%; }
    #message { font-family:system-ui,Segoe UI,Roboto,Arial; color:#333; }
    iframe { width:100%; height:100%; border:0; display:block; }
  </style>
</head>
<body>
  <div id="app" class="center">
    <div id="message">Loading...</div>
  </div>

  <script>
    // Apply tab cloak immediately (before any other scripts run)
    (function applyCloak() {
      const title = localStorage.getItem("cloakTitle");
      const icon  = localStorage.getItem("cloakIcon");

      if (title) {
        document.title = title;
      }

      if (icon) {
        const favicon = document.getElementById("cloakFavicon");
        if (favicon) {
          favicon.href = icon;
        }
        // Also update all existing favicon links
        const existingFavicons = document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]');
        existingFavicons.forEach(link => {
          link.href = icon;
        });
      }
      
      // Listen for iframe load and apply cloak to iframe's title if possible
      // (Note: Cross-origin restrictions may prevent this)
    })();

    // Main loader system
    (function () {
      const app = document.getElementById('app');

      function showError(text) {
        app.innerHTML = '<div id="message">' + text + '</div>';
      }

      // Read ?content=
      const params = new URLSearchParams(window.location.search);
      const raw = params.get('content');

      if (!raw) {
        showError('Error: no "content" parameter provided.');
        return;
      }

      // Decode and validate URL
      let decoded;
      try { decoded = decodeURIComponent(raw); }
      catch { showError('Error: could not decode the content parameter.'); return; }

      let url;
      try { url = new URL(decoded); }
      catch { showError('Error: invalid URL.'); return; }

      if (!["http:", "https:"].includes(url.protocol)) {
        showError('Error: URL must start with http:// or https://');
        return;
      }

      // Create iframe and load the URL directly (no about:blank)
      const iframe = document.createElement('iframe');
      iframe.src = url.href;

      iframe.addEventListener('error', () => {
        showError('Error: failed to load the provided URL.');
      });

      app.innerHTML = '';
      app.appendChild(iframe);
    })();
  </script>
</body>
</html>
